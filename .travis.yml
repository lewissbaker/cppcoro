# Copyright Lewis Baker 2017
#
# Distributed under MIT license.
# See LICENSE.txt file for details.

language: cpp

os: linux

dist: trusty

git:
  submodules: true

addons:
  apt:
    packages:
    - python2.7
    - ninja

compiler:
- clang
    
env:
  global:
  - TOOLS_DIR=${TRAVIS_BUILD_DIR}/tools
  - LLVM_INSTALL_PREFIX=${TOOLS_DIR}/llvm
  - CMAKE_VERSION="3.9.1"
  include:
  - RELEASE=debug ARCH=x86
  - RELEASE=optimised ARCH=x86
  - RELEASE=debug ARCH=x64
  - RELEASE=optimised ARCH=x64
 
cache:
  directories:
  - ${TOOLS_DIR}/cmake-${CMAKE_VERSION}
 
before_install:
- |
  if [ ! -f "${TOOLS_DIR}/cmake-${CMAKE_VERSION}/cached" ]; then
    CMAKE_URL="https://cmake.org/files/v3.9/cmake-${CMAKE_VERSION}-Linux-x86_64.tar.gz"
    mkdir -p "${TOOLS_DIR}/cmake-${CMAKE_VERSION}"
    travis_retry wget --no-check-certificate --quiet -O - "${CMAKE_URL}" | tar --strip-components=1 -xz -C "${TOOLS_DIR}/cmake-${CMAKE_VERSION}"
    touch "${TOOLS_DIR}/cmake-${CMAKE_VERSION}/cached"
  else
    echo "Using cached CMake version ${CMAKE_VERSION}"
  fi
  export PATH="${TOOLS_DIR}/cmake-${CMAKE_VERSION}/bin:$PATH"
- ./build-clang.sh
- export PATH="${LLVM_INSTALL_PREFIX}/bin:$PATH"

before_script:
- source ./init.sh

script:
- cake architecture=$ARCH release=$RELEASE

notifications:
  email: false
